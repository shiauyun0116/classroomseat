import React, { useState, useEffect, useRef } from 'react';
import { User, Shuffle, RotateCcw, Monitor, CheckCircle, Trash2, Users, Wifi, WifiOff } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  deleteDoc, 
  onSnapshot, 
  getDocs,
  writeBatch
} from 'firebase/firestore';

// --- Firebase 初始化 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function App() {
  const TOTAL_SEATS = 36;
  
  // 狀態管理
  const [user, setUser] = useState(null);
  const [seats, setSeats] = useState(Array(TOTAL_SEATS).fill(null));
  const [studentName, setStudentName] = useState('');
  const [isDrawing, setIsDrawing] = useState(false);
  const [highlightedSeat, setHighlightedSeat] = useState(null);
  const [history, setHistory] = useState([]);
  const [connectionStatus, setConnectionStatus] = useState('connecting'); // connecting, connected, error
  
  // 提示訊息
  const [message, setMessage] = useState(null);

  // 1. 初始化 Auth
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
        setConnectionStatus('error');
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) setConnectionStatus('connected');
    });
    return () => unsubscribe();
  }, []);

  // 2. 監聽 Firestore 資料 (seats)
  useEffect(() => {
    if (!user) return;

    // 我們將座位資料存在 'seats' 集合中，document ID 為座位索引 (0-35)
    // 路徑規則: /artifacts/{appId}/public/data/seats
    const seatsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'seats');
    
    // 監聽座位變化
    const unsubscribeSeats = onSnapshot(seatsCollectionRef, 
      (snapshot) => {
        const newSeats = Array(TOTAL_SEATS).fill(null);
        const newHistory = [];

        snapshot.forEach((doc) => {
          const data = doc.data();
          const index = parseInt(doc.id);
          if (index >= 0 && index < TOTAL_SEATS) {
            newSeats[index] = data.name;
            // 收集歷史紀錄 (如果有 timestamp)
            if (data.timestamp) {
                newHistory.push({
                    name: data.name,
                    seat: index + 1,
                    time: new Date(data.timestamp).toLocaleTimeString(),
                    timestamp: data.timestamp // 用於排序
                });
            }
          }
        });
        
        setSeats(newSeats);
        // 依時間倒序排列歷史紀錄
        newHistory.sort((a, b) => b.timestamp - a.timestamp);
        setHistory(newHistory);
      },
      (error) => {
        console.error("Firestore error:", error);
        setConnectionStatus('error');
        showMessage("連線中斷，請重新整理", "error");
      }
    );

    return () => unsubscribeSeats();
  }, [user]);

  // 自動清除訊息
  useEffect(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [message]);

  const showMessage = (text, type = 'error') => {
    setMessage({ text, type });
  };

  // 取得空位索引
  const getEmptySeats = () => {
    return seats.map((seat, index) => seat === null ? index : null).filter(val => val !== null);
  };

  // 執行抽籤
  const handleDraw = async () => {
    if (!studentName.trim()) {
      showMessage('請先輸入學生姓名！', 'error');
      return;
    }

    if (!user) {
      showMessage('尚未連線到伺服器', 'error');
      return;
    }

    // 取得目前的空位 (基於本地最新狀態)
    const currentEmptySeats = getEmptySeats();
    
    if (currentEmptySeats.length === 0) {
      showMessage('所有座位都已經坐滿了！', 'error');
      return;
    }

    setIsDrawing(true);
    let count = 0;
    const maxShuffles = 15; // 動畫次數
    const intervalTime = 80;

    // 開始動畫
    const interval = setInterval(async () => {
      // 隨機亮燈效果
      const randomTempIndex = currentEmptySeats[Math.floor(Math.random() * currentEmptySeats.length)];
      setHighlightedSeat(randomTempIndex);
      count++;

      // 動畫結束，執行真正的資料庫寫入
      if (count >= maxShuffles) {
        clearInterval(interval);
        
        // --- 關鍵：再次檢查空位 ---
        // 動畫跑的這幾秒，可能有人先搶走了，所以要重新計算真正的空位
        // 為了確保不衝突，我們嘗試隨機選位，如果失敗(已被佔用)可以重試，
        // 但為了簡單與流暢，我們這裡重新讀取一次目前的 seats 狀態來選位。
        
        // 這裡直接使用 state 中的 seats，因為 onSnapshot 會保持它是最新的
        const freshEmptySeats = seats.map((seat, index) => seat === null ? index : null).filter(val => val !== null);

        if (freshEmptySeats.length === 0) {
          setIsDrawing(false);
          setHighlightedSeat(null);
          showMessage('哎呀！剛好位置被搶光了', 'error');
          return;
        }

        const finalSeatIndex = freshEmptySeats[Math.floor(Math.random() * freshEmptySeats.length)];
        
        try {
          // 寫入 Firestore
          const seatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'seats', finalSeatIndex.toString());
          
          await setDoc(seatDocRef, {
            name: studentName,
            userId: user.uid,
            timestamp: Date.now()
          });

          setStudentName(''); // 清空輸入
          showMessage(`恭喜！抽中 ${finalSeatIndex + 1} 號座位`, 'success');

        } catch (error) {
          console.error("Write error:", error);
          showMessage('寫入失敗，請重試', 'error');
        } finally {
          setIsDrawing(false);
          setHighlightedSeat(null);
        }
      }
    }, intervalTime);
  };

  // 重置所有座位
  const handleReset = async () => {
    if (!confirm('確定要清空所有座位嗎？這會影響所有連線的使用者。')) return;

    try {
        const seatsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'seats');
        const snapshot = await getDocs(seatsCollectionRef);
        
        // 使用 Batch 批次刪除
        const batch = writeBatch(db);
        snapshot.docs.forEach((doc) => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        showMessage('已重置所有座位', 'success');
        setStudentName('');
    } catch (error) {
        console.error("Reset error:", error);
        showMessage('重置失敗', 'error');
    }
  };

  // 移除特定學生
  const handleRemoveStudent = async (index, currentName) => {
    if (!confirm(`確定要移除 ${index + 1} 號座位的 ${currentName} 嗎？`)) return;

    try {
        const seatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'seats', index.toString());
        await deleteDoc(seatDocRef);
        showMessage(`已移除 ${index + 1} 號座位`, 'success');
    } catch (error) {
        showMessage('移除失敗', 'error');
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !isDrawing) {
      handleDraw();
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800 relative">
      
      {/* 頂部訊息提示 */}
      {message && (
        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 animate-fadeIn flex items-center gap-2 text-white font-bold ${message.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
          {message.type === 'error' ? <Monitor size={20}/> : <CheckCircle size={20}/>}
          {message.text}
        </div>
      )}

      {/* 連線狀態指示燈 */}
      <div className="absolute top-4 right-4 flex items-center gap-2 text-sm bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-200">
        {connectionStatus === 'connected' ? (
          <>
            <Wifi className="text-green-500" size={16} />
            <span className="text-slate-600">已連線同步中</span>
          </>
        ) : connectionStatus === 'error' ? (
          <>
            <WifiOff className="text-red-500" size={16} />
            <span className="text-red-500">連線中斷</span>
          </>
        ) : (
          <>
            <div className="w-4 h-4 rounded-full border-2 border-slate-300 border-t-blue-500 animate-spin"></div>
            <span className="text-slate-400">連線中...</span>
          </>
        )}
      </div>

      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 mt-8">
        
        {/* 左側控制面板 */}
        <div className="lg:col-span-4 space-y-6">
          <div className="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
            <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center gap-2">
              <Users className="text-blue-600" />
              雲端同步座位表
            </h1>
            <p className="text-slate-500 text-sm mb-6">多人連線版：輸入姓名，系統自動同步全班狀態。</p>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">學生姓名</label>
                <input
                  type="text"
                  value={studentName}
                  onChange={(e) => setStudentName(e.target.value)}
                  onKeyPress={handleKeyPress}
                  disabled={isDrawing || getEmptySeats().length === 0 || connectionStatus !== 'connected'}
                  placeholder="輸入姓名..."
                  className="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-lg"
                />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={handleDraw}
                  disabled={isDrawing || !studentName.trim() || getEmptySeats().length === 0 || connectionStatus !== 'connected'}
                  className={`col-span-2 py-3 px-4 rounded-xl flex items-center justify-center gap-2 text-white font-bold text-lg transition-all transform active:scale-95 shadow-md
                    ${isDrawing || !studentName.trim() || getEmptySeats().length === 0 || connectionStatus !== 'connected'
                      ? 'bg-slate-300 cursor-not-allowed' 
                      : 'bg-blue-600 hover:bg-blue-700 hover:shadow-lg'}`}
                >
                  {isDrawing ? (
                    <>
                      <Shuffle className="animate-spin" size={20} />
                      抽籤中...
                    </>
                  ) : (
                    <>
                      <CheckCircle size={20} />
                      確認抽籤
                    </>
                  )}
                </button>
              </div>

              <div className="pt-4 border-t border-slate-100 flex justify-between items-center text-sm text-slate-500">
                <span>剩餘空位: {getEmptySeats().length} / {TOTAL_SEATS}</span>
                <button 
                  onClick={handleReset}
                  className="text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1 rounded-lg transition-colors flex items-center gap-1"
                >
                  <RotateCcw size={14} /> 全班重置
                </button>
              </div>
            </div>
          </div>

          {/* 最新動態 / 歷史紀錄 */}
          <div className="bg-white rounded-2xl shadow-sm p-6 border border-slate-200 h-[300px] overflow-hidden flex flex-col">
            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
              <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              最新入座 (即時)
            </h3>
            <div className="overflow-y-auto flex-1 space-y-2 pr-2">
              {history.length === 0 ? (
                <div className="text-center text-slate-400 py-8">
                  尚無紀錄
                </div>
              ) : (
                history.map((record, idx) => (
                  <div key={idx} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm animate-fadeIn">
                    <div className="flex flex-col">
                        <span className="font-medium text-slate-700">{record.name}</span>
                        <span className="text-xs text-slate-400">{record.time}</span>
                    </div>
                    <span className="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">
                      {record.seat} 號座
                    </span>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>

        {/* 右側座位表 */}
        <div className="lg:col-span-8">
          <div className="bg-white rounded-2xl shadow-sm p-6 md:p-8 border border-slate-200">
            
            {/* 講台區域 */}
            <div className="mb-8 w-full flex justify-center">
              <div className="bg-slate-800 text-white py-3 px-16 rounded-lg shadow-md flex items-center gap-3">
                <Monitor size={24} />
                <span className="text-xl font-bold tracking-widest">講 台 / 黑 板</span>
              </div>
            </div>

            {/* 座位網格 */}
            <div className="grid grid-cols-6 gap-3 md:gap-4 aspect-square md:aspect-auto">
              {seats.map((seatName, index) => {
                const seatNumber = index + 1;
                const isOccupied = seatName !== null;
                const isHighlighted = highlightedSeat === index;
                
                return (
                  <div
                    key={index}
                    onClick={() => isOccupied && !isDrawing && handleRemoveStudent(index, seatName)}
                    className={`
                      relative group aspect-square md:aspect-[4/3] rounded-xl border-2 flex flex-col items-center justify-center p-2 transition-all duration-300
                      ${isHighlighted 
                        ? 'border-yellow-400 bg-yellow-100 scale-105 shadow-xl z-10' 
                        : isOccupied 
                          ? 'border-blue-200 bg-blue-50 hover:border-red-200 hover:bg-red-50 cursor-pointer' 
                          : 'border-slate-200 bg-slate-50'
                      }
                    `}
                  >
                    {/* 座號浮水印 */}
                    <span className={`absolute top-1 left-2 text-xs font-bold ${isOccupied ? 'text-blue-300' : 'text-slate-300'}`}>
                      {seatNumber}
                    </span>

                    {/* 學生姓名 */}
                    {isOccupied ? (
                      <>
                        <span className="font-bold text-slate-800 text-sm md:text-lg break-all text-center leading-tight animate-fadeIn">
                          {seatName}
                        </span>
                        {/* 懸停時顯示移除圖示 */}
                        <div className="absolute inset-0 flex items-center justify-center bg-red-100/90 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity">
                          <Trash2 className="text-red-500" size={24} />
                        </div>
                      </>
                    ) : (
                      <span className="text-slate-300">
                        <User size={24} />
                      </span>
                    )}
                  </div>
                );
              })}
            </div>

            <div className="mt-6 text-center text-slate-400 text-sm">
              <p>雲端同步模式：所有人的畫面將保持一致</p>
            </div>
          </div>
        </div>

      </div>
      
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out forwards;
        }
      `}</style>
    </div>
  );
}